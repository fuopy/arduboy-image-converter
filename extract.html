<!DOCTYPE html>

<html>
<head>
	<meta charset="utf-8">
	<title>Image Extractor</title>

    <style type="text/css">
h1, h3 {
    text-align: center;
    text-shadow: 2px 2px black;
}
h4 {
    text-align: right;
    text-shadow: 2px 2px black;
}
body {
    font-family: Arial;
    background-color: #AD8E58;
    color: white;
}
a {
    color: white;
    text-decoration: none;
}
a:hover {
    color: yellow;
    background-color: black;
}
.image-view {
    display: inline-block;
    font-size: 1pt;
    border: 2px solid lightgrey;
    margin: 1px;
}
.image-view:hover {
    border: 2px solid red;
}
#ino-download-pane {
    background-color: rgba(0, 0, 0, 0.5);
    margin: 6px;
    padding: 6px;
    float: left;
}
canvas,
img {
    image-rendering: crisp-edges;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor;
}
.inputForm {
    border: 3px solid black;
    color: black;
    display: inline-block;
    background-color: rgb(189, 126, 31);
}
.submitArea {
    text-align: right;
    background-color: rgb(34, 27, 11);
    padding: 3px;
}
    </style>
</head>
<body>
	<h1>Arduboy Game Image Converter</h1>
	<h3>Paste data into this page, type in the dimensions, hit convert!</h3>

    <div class="inputForm">
        <table>
            <tr>
                <td>Sprite data from C++ Project:</td>
                <td><input type="text" id="dataForm"></td>
            </tr>
            <tr>
                <td>Sprite width:</td>
                <td><input type="text", id="spriteWidthForm"></td>
            </tr>
            <tr>
                <td>Sprite height:</td>
                <td><input type="text", id="spriteHeightForm"></td>
            </tr>
            <tr>
                <td>Separate sprite images:</td>
                <td><input type="checkbox", id="separateSpriteImages"></td>
            </tr>
        </table>

        <div class="submitArea">
            <input type="button" onclick="clearData();" value="Clear Inputs">
            <input type="button" onclick="submitData();" value="Convert">
        </div>
    </div>

    <br />

    <hr />
    <div id="SpriteCanvasContainer"></div>
    <hr />


	<h4>
		<a href="https://github.com/fuopy/arduboy-image-converter">View on GitHub</a></p>
	</h4>
    
    <script type="text/javascript">

//const parserExpression = /(0x\d\d+)/g;
//const parserExpression = /(0x\d\d+)/g;
function parseText(text)
{
    // Parse text into an array of bytes.
    let outputBytes = [];

    for (const s of text.matchAll(/([0-9A-Fa-f][0-9A-Fa-f]+)/g))
    {
        //console.log("converting", s, "to", parseInt(s, 16))
        outputBytes.push(parseInt(s, 16));
    }

    return outputBytes;
}

function drawByte(context, x, y, byteValue)
{
    // Draw each pit as a pixel.
    // Top: Most Significant Bit
    context.fillStyle = (byteValue & 0b00000001) ? "white" : "black";
    context.fillRect(x, y+0, 1, 1);
    context.fillStyle = (byteValue & 0b00000010) ? "white" : "black";
    context.fillRect(x, y+1, 1, 1);
    context.fillStyle = (byteValue & 0b00000100) ? "white" : "black";
    context.fillRect(x, y+2, 1, 1);
    context.fillStyle = (byteValue & 0b00001000) ? "white" : "black";
    context.fillRect(x, y+3, 1, 1);
    context.fillStyle = (byteValue & 0b00010000) ? "white" : "black";
    context.fillRect(x, y+4, 1, 1);
    context.fillStyle = (byteValue & 0b00100000) ? "white" : "black";
    context.fillRect(x, y+5, 1, 1);
    context.fillStyle = (byteValue & 0b01000000) ? "white" : "black";
    context.fillRect(x, y+6, 1, 1);
    context.fillStyle = (byteValue & 0b10000000) ? "white" : "black";
    context.fillRect(x, y+7, 1, 1);
    // Bottom: Least Significant Bit
}

function createSpriteCanvas(width, height)
{
    let el = document.createElement("canvas");

    el.width = width;
    el.height = height;
    el.className = "image-view";
    el.onclick = function() {
        let url = el.toDataURL();
        window.open(url);
    };

    return el;
}


function clearData()
{
    // Clear the input fields.
    let dataForm = document.querySelector("#dataForm");
    let spriteWidthElement = document.querySelector("#spriteWidthForm");
    let spriteHeightElement = document.querySelector("#spriteHeightForm");
    dataForm.value = "";
    spriteWidthElement.value = "";
    spriteHeightElement.value = "";
}

function previewImage()
{
    console.log("hi");
}

function submitData()
{
    // Get the elements and canvas context.
    let dataForm = document.querySelector("#dataForm");
    let spriteWidthElement = document.querySelector("#spriteWidthForm");
    let spriteHeightElement = document.querySelector("#spriteHeightForm");
    let separateSpriteImagesElement = document.querySelector("#separateSpriteImages");
    let spriteCanvasContainer = document.querySelector("#SpriteCanvasContainer");

    // Get the width/height of the sprite
    let spriteWidth = spriteWidthElement.value;
    let spriteHeight = spriteHeightElement.value;

    // Parse the C++ data.
    let bytes = parseText(dataForm.value);

    let breakElement = document.createElement("br");

    // Setting: put each image on its own sprite.
    let splitSpritesSetting = separateSpriteImagesElement.checked;

    // Draw all pixels on the canvas.
    let x = 0;
    let y = 0;
    let processedWidth = 0;
    let processedHeight = 0;
    let completedCanvases = [];

    let activeCanvas;

    // Create many small canvases if the setting to split sprites is enabled.
    if (splitSpritesSetting)
    {
        activeCanvas = createSpriteCanvas(spriteWidth, spriteHeight);
    }
    // Create one tall canvas otherwise. Calculate the max height.
    else
    {
        let numberOfSprites = Math.floor(bytes.length / ((spriteHeight/8) * spriteWidth));
        activeCanvas = createSpriteCanvas(spriteWidth, spriteHeight * numberOfSprites);
    }
    let activeCanvasContext = activeCanvas.getContext("2d");
    for (const byte of bytes)
    {
        drawByte(activeCanvasContext, x, y, byte);
        x++;
        processedWidth++;

        // Go down eight pixels if we hit the width of the sprite.
        if (processedWidth >= spriteWidth)
        {
            x = 0;
            y += 8;
            processedWidth = 0;
            processedHeight += 8;
        }

        // Complete the sprite if we hit the height of the sprite.
        if (processedHeight >= spriteHeight)
        {
            // Split each sprite to its own image if the setting is enabled.
            if (splitSpritesSetting)
            {
                // Save the completed sprite canvas.
                completedCanvases.push(activeCanvas);

                // Start a new canvas.
                activeCanvas = createSpriteCanvas(spriteWidth, spriteHeight);
                activeCanvasContext = activeCanvas.getContext("2d");
                x = 0;
                y = 0;
                processedWidth = 0;
                processedHeight = 0;
            }
        }
    }

    if (!splitSpritesSetting)
    {
        completedCanvases.push(activeCanvas);
    }

    // Add the created element to the page.
    for (const el of completedCanvases)
    {
        console.log("iter", el);
        spriteCanvasContainer.appendChild(el);
        spriteCanvasContainer.appendChild(breakElement);
    }

    // Log that we're done!
    console.log("Done.");
}
    </script>
</body>
</html>